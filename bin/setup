#!/usr/bin/env ruby
require "fileutils"

# path to your application root.
APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

def rails_container_exec(cmd)
  system("docker exec -w /home/lucky/app rails7app-rails-1 /bin/bash -c '#{cmd}'")
end

def check_docker
  unless system('docker -v')
    puts "Docker not found"
    exit 1
  end
end

DELAY = 3

FileUtils.chdir APP_ROOT do
  check_docker

  FileUtils.rm('db/PGSQL/.keep', force: true)

  puts "1. Launching PgSQL container"
  system('docker compose -f docker/docker-compose.yml up psql -d')

  puts "Waiting #{DELAY} seconds to initialize PgSQL database"
  sleep(DELAY)

  FileUtils.touch('db/PGSQL/.keep', verbose: true)

  puts "2. Launching Rails container"
  puts "Waiting #{DELAY} seconds to run Rails Container"
  system('docker compose -f docker/docker-compose.yml up rails -d')
  sleep(DELAY)

  puts "3. Installing Gems. Please Wait"
  rails_container_exec("bundle install")

  puts "4. Create DB. Migrate DB. Create Seeds"
  rails_container_exec("rake db:prepare")

  puts "5. Launching Redis Container"
  puts "Waiting #{DELAY} seconds to run Redis Container"
  system('docker compose -f docker/docker-compose.yml up redis -d')
  sleep(DELAY)

  puts "Waiting #{DELAY} seconds to run Redis Container"
  system('docker compose -f docker/docker-compose.yml up redis -d')
  sleep(DELAY)

  puts "6. Generate Sphinx Config"
  rails_container_exec("rake ts:configure")

  puts "7. Launching Sphinx Container"
  puts "Waiting #{DELAY} seconds to run Sphinx Container"
  system('docker compose -f docker/docker-compose.yml up sphinx -d')
  sleep(DELAY)

  puts "8. Indexing Article Model"
  system('docker exec rails7app-sphinx-1 indexer --all --config /opt/sphinx/conf/sphinx.conf')
  sleep(DELAY)

  puts "9. Launching Rails App on the port 3000"
  rails_container_exec("bundle exec puma -C config/_PUMA.rb &")

  puts "10. Visit: http://localhost:3000"
end
