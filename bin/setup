#!/usr/bin/env ruby
require "fileutils"
require_relative "./helpers.rb"

# path to your application root.
APP_ROOT = File.expand_path("..", __dir__)

FileUtils.chdir APP_ROOT do
  check_docker!

  FileUtils.rm('db/PGSQL/.keep', force: true)

  puts "1. Launching PgSQL container"
  system('docker compose -f docker/docker-compose.yml up psql -d')

  wait('to initialize PgSQL database')

  FileUtils.touch('db/PGSQL/.keep', verbose: true)

  puts "2. Launching Rails container"
  system('docker compose -f docker/docker-compose.yml up rails -d')

  wait('to launch Rails Container')

  puts "3. Installing Gems. Please Wait"
  rails_install_gems

  puts "4. Create DB. Migrate DB. Create Seeds"
  container_bash_exec('rails', 'rake db:prepare')

  puts "5. Launching Redis Container"
  system('docker compose -f docker/docker-compose.yml up redis -d')

  wait('to launch Redis Container')

  puts "6. Generate Sphinx Config"
  container_bash_exec('rails', 'rake ts:configure')

  puts "7. Launching Sphinx Container"
  system('docker compose -f docker/docker-compose.yml up sphinx -d')

  wait('to launch Sphinx Container')

  puts "8. Launching ElasticSearch Container"
  system('docker compose -f docker/docker-compose.yml up elastic -d')

  wait('to launch ElasticSearch Container', 10)

  puts "9. Indexing Article Model"
  sphinx_index
  chewy_index

  puts "10. Launching Rails App with Puma"
  puma_start

  puts "11. Launching Sidekiq"
  sidekiq_start

  puts "12. Visit: http://localhost:3000"

  containers_information
end
